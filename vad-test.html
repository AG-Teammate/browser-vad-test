<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>VAD Test</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <script type="text/javascript" src="packages/vad.js/lib/vad.js"></script>
    <script type="text/javascript">
    <!--
    function initialize() {
      // web�֥饦���֤�AudioContext (�����������֥�������)ɽ������ۼ�����
      window.AudioContext = window.AudioContext || window.webkitAudioContext;

      // AudioContext���������
      var audioContext = new AudioContext();

      // ���������������ؿ��ʲ���getUserMedia�Υ�����Хå��Ȥ��ơ��ޥ����Ȥ���³���ϻ��˼¹ԡ�
      function startUserMedia(stream) {

        // �������ȥ꡼�಻�����֥������Ȥκ���
        var source = audioContext.createMediaStreamSource(stream);

        // VAD �Υ��ץ�������� (�ܺٸ��)
        var options = {
          source: source,  // ��ָ����оݤȤʤ륹�ȥ꡼�಻�����֥������Ȥλ���
          voice_stop: voice_stop, // ������ָ��г��ϻ��ϥ�ɥ����
          voice_start: voice_start, // ������ָ��н�λ���ϥ�ɥ����
          energy_threshold_ratio_pos: 8, // Signal must be twice the offset
          energy_threshold_ratio_neg: 0.5, // Signal must be half the offset
          energy_integration: 1, // Size of integration change compared to the signal per second.

        };

        // VAD���֥������Ⱥ��� (�ʤ����ܥ��֥������Ȥϰʹ߻��Ѥ���ɬ�פϤʤ�)
        var vad = new VAD(options);
      }

      // web�֥饦���֤�getUserMedia(�����������ǥХ������������ѥ��֥�������)ɽ������ۼ�����
      navigator.getUserMedia = navigator.getUserMedia ||
              navigator.mozGetUserMedia ||
              navigator.webkitGetUserMedia;

      // getUserMedia��ư�����ޥ������������򳫻Ϥ���
      navigator.getUserMedia(
              {audio: true},  // ���ץ����(����(audio)�ǥХ����إ�������)
              startUserMedia, // ������������Хå����� (�嵭�ˤ��������startUserMedia�ؿ�)
              function (e) {   // ���顼��������Хå�����
                console.log("No live audio input in this browser: " + e);
              }
      );

      document.querySelectorAll(".startLink").forEach((el)=>el.remove());

      const statusEl = document.querySelector(".status");
      statusEl.innerText = "Please speak now...";
      let speechStart = new Date();
      let pauseStart = new Date();
      function voice_start() {
        let pauseForMs = (new Date() - pauseStart);
        statusEl.innerText = "Speaking... (after " + pauseForMs + " ms pause)";
        speechStart = new Date();
      }

      function voice_stop() {
        let spokeForMs = (new Date() - speechStart);
        statusEl.innerText = "Spoke for " + spokeForMs + " ms.";
        pauseStart = new Date();
      }
    }
    -->
    </script>
  </head>
  <body>
    <a href="#" class="startLink" onclick="initialize()">Click here to start....</a>
    <div class="status"></div>
  </body>
</html>
